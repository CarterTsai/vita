#!snabb snsh

-- Use of this source code is governed by the GNU AGPL license; see COPYING.

local shm = require("core.shm")
local worker = require("core.worker")
local vita = require("program.vita.vita")
local yang = require("lib.yang.yang")
local S = require("syscall")

local confpath = shm.root.."/"..shm.resolve("group/testconf")

local function commit_conf (conf)
   vita.save_config(vita.schemata['esp-gateway'], confpath, conf)
end

worker.set_exit_on_worker_death(true)

worker.start(
   "PublicRouterLoopback",
   ([[require("program.vita.vita").public_router_loopback_worker(%q)]])
      :format(confpath)
)
worker.start(
   "Exchange",
   ([[require("program.vita.vita").exchange_worker(%q)]])
      :format(confpath)
)
S.sleep(1)

local conf0 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.1",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.1",
   route = {}
}
print("Committing base configuration...")
commit_conf(conf0)
S.sleep(3)

local conf1 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.1",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.1",
   route = {
      loopback = {
         net_cidr4 = "192.168.10.0/24",
         gw_ip4 = "203.0.113.1",
         preshared_key = string.rep("00", 32),
         spi = 1001
      }
   }
}
print("Adding a route...")
commit_conf(conf1)
S.sleep(3)

print("Update without change...")
commit_conf(conf1)
S.sleep(3)

local conf2 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.1",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.1",
   route = {
      loopback = {
         net_cidr4 = "192.168.10.0/24",
         gw_ip4 = "203.0.113.1",
         preshared_key = string.rep("FF", 32),
         spi = 1001
      }
   }
}
print("Change route key...")
commit_conf(conf2)
S.sleep(3)

local conf3 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.1",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.1",
   route = {
      loopback = {
         net_cidr4 = "192.168.10.0/24",
         gw_ip4 = "203.0.113.2",
         preshared_key = string.rep("FF", 32),
         spi = 1001
      }
   }
}
print("Change route gw_ip4...")
commit_conf(conf3)
S.sleep(3)

local conf4 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.2",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.2",
   route = {
      loopback = {
         net_cidr4 = "192.168.10.0/16",
         gw_ip4 = "203.0.113.2",
         preshared_key = string.rep("FF", 32),
         spi = 1001
      }
   }
}
print("Change public_ip4 and route net_cidr4...")
commit_conf(conf4)
S.sleep(3)

local conf5 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.2",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.2",
   route = {
      loopback2 = {
         net_cidr4 = "192.168.10.0/16",
         gw_ip4 = "203.0.113.2",
         preshared_key = string.rep("FF", 32),
         spi = 1001
      }
   }
}
print("Change route id...")
commit_conf(conf5)
S.sleep(3)

local conf6 = {
   private_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:00" },
   public_interface = { pciaddr = "00:00.0", macaddr = "52:54:00:00:00:FF" },
   private_ip4 = "192.168.10.1",
   public_ip4 = "203.0.113.2",
   private_nexthop_ip4 = "192.168.10.1",
   public_nexthop_ip4 = "203.0.113.2",
   negotiation_ttl = 1,
   route = {
      loopback2 = {
         net_cidr4 = "192.168.10.0/16",
         gw_ip4 = "203.0.113.2",
         preshared_key = string.rep("FF", 32),
         spi = 1001
      }
   }
}
print("Change negotiation_ttl...")
commit_conf(conf6)
S.sleep(3)

print("Remove route...")
commit_conf(conf0)
S.sleep(3)
